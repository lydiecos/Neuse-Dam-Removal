---
output: 
  pdf_document:
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
geometry: margin=2.54cm
title: "Impacts of Dam Removal on the Shenandoah River"
subtitle: "https://github.com/lydiecos/WDA-Dam-Removal"
author: "Lydie Costes"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
---

\newpage

```{r setup, include=FALSE}
# Get working directory
getwd()

# Load packages
library(tidyverse)
library(lubridate)
library(dataRetrieval)
# install.packages("mcp")
library(mcp)

# Set ggplot theme
theme_set(theme_bw())

# Set number format
options(scipen=8)

# Possible sites:
# 01631000
# info: https://dwr.virginia.gov/fishing/fish-passage/#orange


# Load datasets
# Download list of available parameters
ShenaParams <- whatNWISdata(siteNumbers = "01631000")
# Download discharge data
ShenaFlow <- readNWISdv(siteNumbers = "01631000",
                    parameterCd = "00060",
                     startDate = "",
                     endDate = "")

# Most common parameters:
# 00095 Specific conductance
# 00010 Temperature C
# 80154 Suspended sediments mg/L
# 00400 pH
# 00900 Hardness - sum of calcium and magnesium. Check time scales of each
# 00660 Orthophosphate mg/L
# 00631 Nitrate mg/L
# 00945 Sulfate, mg/L
# 00925 Magnesium, mg/L
# 00915 Calcium, mg/L

# Download water quality data
ShenaWQ  <- readWQPqw(siteNumbers = "USGS-01631000",
                      parameterCd = c("00631", # nitrate, mg/L
                                      "00660", # phosphate, mg/L
                                      "00915", # calcium, filtered mg/L
                                      "00925", # magnesium, filtered mg/L
                                      "00400", # pH
                                      "80154", # Suspended sediments mg/L
                                      "00095", # Specific conductance
                                      "00900", # Hardness 
                                      "00010"), # Temperature C
                      startDate = "",
                      endDate = )

```


# Rationale and Research Questions

Over the past century, perceptions of dams have gradually changed, as understanding of their serious ecological issues has increased and as existing dams have aged, creating safety concerns and the need for expensive repairs. Dams block the passage of fish and other aquatic species, seriously disrupting life cycles for some species. They also impact water quality and alter natural flow. Increasingly, dam removal is pursued as an option to deal with aging dams and restore rivers. 

In this study, we seek to understand how dam removal has impacted the physical and chemical processes of one river, the Neuse River in North Carolina. From 2004-2005, three dams were removed from the Southern Fork of the Shenandoah River (see map below). The gage we are using for these analyses is downstream from these dams and should thus reflect some of the changes in flow and water quality that occurred after these removals.  

Below: The red X marks the spot of the McGaheysville Dam, which were removed along with the Knightly Dam and Rockland Dam upstream in 2004-2005. All three dams were located along the south fork of the Shenandoah River, which feeds into the Potomac.
![map of Neuse River](../Figures-and-Maps/mcgaheysvilledam.png)

We are interested in both changes in physical process and changes in chemical processes, which can vary widely according to the specific river, its history, and the dam removal process (Foley et al 2017). Dams allow for moderation of flow, often eliminating extreme flooding events. Therefore, dam removal in combination with increasing extreme weather events due to climate change could lead to more extreme and more frequent high flow events. On the other hand, natural river systems and riparian areas can be more resilient to flood events than artificially constructed channels, so true restoration could help mitigate high flow events to some extent. 

Changes in water quality are also an area of interest. Large amounts of sediment and minerals built up behind the dam may release quickly after removal, especially if the removal was sudden rather than gradual (Foley et al 2017). Over longer time, water quality is expected to improve because of restored ecological processes.

## Question 1: Have discharge levels become more extreme since dam removal?

## Question 2: Has there been an increase in release of sediment and nutrients over time? 
#+ Have levels steadily increased since dam removal, or did they spike and then stabilize?



\newpage

# Dataset Information

```{r wrangling}
# Change column names
names(ShenaFlow)[4:5] <- c("Discharge", "Approval.Code")

# Add month and year column
ShenaFlow <- ShenaFlow %>%
  mutate(Month = month(Date),
         Year = year(Date))

# Check dimensions
dim(ShenaFlow)
# Check Flow data formats
str(ShenaFlow)
# Check Flow data summary
summary(ShenaFlow)

# Create monthly summary dataset of discharge
ShenaFlow_monthly <- ShenaFlow %>%
  group_by(Year, Month) %>%
  summarise(Discharge_min = min(Discharge),
            Discharge_max = max(Discharge),
            Discharge_mean = mean(Discharge)) %>%
  mutate(Date = as.Date(paste(Year, Month, "1", sep = "-"), format = "%Y-%m-%d"))
# Check dimensions and summary of dataset
dim(ShenaFlow_monthly)
summary(ShenaFlow_monthly)

# Create yearly summary dataset of discharge
ShenaFlow_yearly <- ShenaFlow %>%
  group_by(Year) %>%
  summarise(Discharge_min = min(Discharge),
            Discharge_max = max(Discharge),
            Discharge_mean = mean(Discharge))
# Check dimensions and summary of dataset
dim(ShenaFlow_yearly)
summary(ShenaFlow_yearly)

# Convert WQ to wider dataframe with characteristics of interest
ShenaWQ_processed <- ShenaWQ %>%
  select(MonitoringLocationIdentifier, ActivityStartDate, HydrologicCondition,
         CharacteristicName, ResultMeasureValue) %>%
  mutate(Month = month(ActivityStartDate),
         Year = year(ActivityStartDate),
         Variable = case_when(CharacteristicName == "pH" ~ "pH", 
                              CharacteristicName == "Hardness, Ca, Mg" ~ "Hardness",
                              CharacteristicName == "Suspended Sediment Concentration (SSC)" ~ "Sediments_mg.L",
                              CharacteristicName == "Inorganic nitrogen (nitrate and nitrite)" ~ "Nitrogen_mg.L",
                              CharacteristicName == "Orthophosphate" ~ "Phosphate_mg.L",
                              CharacteristicName == "Temperature, water" ~ "Temp_C")) %>%
  select(-CharacteristicName) %>%
  pivot_wider(names_from = "Variable", values_from = "ResultMeasureValue") %>%
  unnest(Calcium_mg.L:Sediments_mg.L)

# Rename the date column
names(ShenaWQ_processed)[2] <- "Date"

# Check the dimensions
dim(ShenaWQ_processed)
# Check the summary
summary(ShenaWQ_processed)
# Check WQ data formats
str(ShenaWQ_processed)

# Create monthly summary dataset of water quality
ShenaWQ_monthly <- ShenaWQ_processed %>%
  group_by(Year, Month) %>%
  summarise(Sediment_min = min(Sediments_mg.L),
            Sediment_max = max(Sediments_mg.L),
            Sediment_mean = mean(Sediments_mg.L),
            Temp_min = min(Temp_C),
            Temp_max = max(Temp_C),
            Temp_mean = mean(Temp_C),
            Nitrogen_min = min(Nitrogen_mg.L),
            Nitrogen_max = max(Nitrogen_mg.L),
            Nitrogen_mean = mean(Nitrogen_mg.L),
            Phosphate_min = min(Phosphate_mg.L),
            Phosphate_max = max(Phosphate_mg.L),
            Phosphate_mean = mean(Phosphate_mg.L)) %>%
  mutate(Date = as.Date(paste(Year, Month, "1", sep = "-"), format = "%Y-%m-%d"))
# Check dimensions and summary of dataset
dim(ShenaWQ_monthly)
summary(ShenaWQ_monthly)

```

\newpage

# Exploratory Analysis 

```{r}
# View flow over time
ggplot(ShenaFlow, aes(x = Date, y = Discharge)) +
  geom_line() +
  geom_smooth(method = "lm") +
  scale_y_log10()

# View pH over time
ggplot(ShenaWQ_processed, aes(x = Date, y = pH)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = "lm")

# View Nitrogen over time
# Elevated levels expected after dam removal but eventual decline
ggplot(ShenaWQ_processed, aes(x = Date, y = Nitrogen_mg.L)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = "lm")
# pull min, max, average

# View Phosphate over time
# Elevated levels expected after dam removal but eventual decline
ggplot(ShenaWQ_processed, aes(x = Date, y = Phosphate_mg.L)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = "lm")

# View Hardness over time
ggplot(ShenaWQ_processed, aes(x = Date, y = Hardness)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = "lm")

# View Temp over time
ggplot(ShenaWQ_processed, aes(x = Date, y = Temp_C)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = "lm")
# consider pulling average max min, and average per month

# View Sediments over time
# Predict increased sediment load right after dam removal, but eventual decline
ggplot(ShenaWQ_processed, aes(x = Date, y = Sediments_mg.L)) +
  geom_point(aes(color = Month)) +
  geom_smooth(method = "lm") +
  scale_x_date(limits = c(as.Date("1970-01-01"), 
                          as.Date("2022-02-17")))

# TO DO
# Pick which analyses to run
# How to do quality analyses, given plentiful gaps in the data?
# Figure out how to do change point detection

```


\newpage

# Analysis

> Question #1: Have discharge extremes increased since the removal of the dams?

```{r  Flow.analysis}
# View monthly min and max flow over time
ggplot(ShenaFlow_monthly, aes(x = Date)) +
  scale_y_log10() +
  geom_line(aes(y = Discharge_min), color = "lightskyblue2") +
  geom_line(aes(y = Discharge_max), color = "steelblue3") +
  geom_vline(xintercept = as.numeric(as.Date("2015-01-01")), linetype = 4)
# Extreme discharge does not appear to have increased. Check yearly because monthly is difficult to see.

# View yearly min, max, mean flow over time
ggplot(ShenaFlow_yearly, aes(x = Year)) +
  scale_y_log10() +
  geom_line(aes(y = Discharge_min), color = "lightskyblue2") +
  geom_line(aes(y = Discharge_max), color = "steelblue") +
  geom_line(aes(y = Discharge_mean), color = "steelblue2") +
  geom_vline(xintercept = as.numeric(2014), linetype = 4) +
  labs(y = "Discharge ()")

# Create before and after datasets
ShenaFlow.before <- ShenaFlow[ShenaFlow$Date < "2004-01-01",]
ShenaFlow.after <- ShenaFlow[ShenaFlow$Date >= "2006-01-01",]

# Flow Time Series
Flow_ts <- ts(ShenaFlow[[4]], frequency = 365, start = c())

# Generate the decomposition
Flow_Decomposed <- stl(Flow_ts, s.window = "periodic")

# Visualize the decomposed series. 
plot(Flow_Decomposed)

# Extract the components and turn them into data frames
Flow_Components <- as.data.frame(Flow_Decomposed$time.series[,1:3])
Flow_Components <- mutate(Flow_Components,
                      Observed = ShenaFlow$Discharge,     
                      Date = ShenaFlow$Date)

# BREAK DOWN BY BEFORE/AFTER DAM REMOVAL
# Flow Time Series: Before the Dam 
# First crop dataset

Flow_ts.before <- ts(ShenaFlow.before[[4]], frequency = 365)

# Generate the decomposition
Flow_Decomposed.before <- stl(Flow_ts.before, s.window = "periodic")

# Visualize the decomposed series. 
plot(Flow_Decomposed.before)

# Extract the components and turn them into data frames
Flow_Components.before <- as.data.frame(Flow_Decomposed.before$time.series[,1:3])
Flow_Components.before <- mutate(Flow_Components.before,
                      Observed = ShenaFlow.before$Discharge,
                      Date = ShenaFlow.before$Date)

# Repeat for after
# Flow Time Series: After the Dam 
Flow_ts.after <- ts(ShenaFlow.after[[4]], frequency = 365)

# Generate the decomposition
Flow_Decomposed.after <- stl(Flow_ts.after, s.window = "periodic")

# Visualize the decomposed series. 
plot(Flow_Decomposed.after)

# Extract the components and turn them into data frames
Flow_Components.after <- as.data.frame(Flow_Decomposed.after$time.series[,1:3])
Flow_Components.after <- mutate(Flow_Components.after,
                      Observed = ShenaFlow.after$Discharge,     
                      Date = ShenaFlow.after$Date)

# Graph before vs after trends
ggplot(Flow_Components) +
  geom_line(aes(y = Observed, x = Date), color = "gray", size = 0.25) +
  geom_line(data = Flow_Components.before, aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_line(data = Flow_Components.after, aes(y = trend, x = Date), color = "darkslateblue") +
  #geom_hline(yintercept = 0, lty = 2) +
  labs(x = "", y = "Discharge (cfs)") +
  scale_y_log10()

# How to break up the analysis (before/after the dam?)
```



\newpage

# Summary and Conclusions


\newpage

# References

* Foley, M. M., J. R. Bellmore, J. E. O'Connor, J. J. Duda, A. E. East, G. E. Grant, C. W. Anderson, J. A. Bountry, M. J. Collins, P. J. Connolly, L. S. Craig, J. E. Evans, S. L. Greene,F. J. Magilligan, C. S. Magirl, J. J. Major, G. R. Pess,T. J. Randle, P. B. Shafroth, C. E. Torgersen, D. Tullos, A. C. Wilcox. 2017. Dam removal: Listening in. Water Resources Research. 53(7):5229-5246. https://doi-org.proxy.lib.duke.edu/10.1002/2017WR020457

Map source: http://www.virginiaplaces.org/watersheds/fishpassage.html

Sediment deposits alter downstream tidal communities https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0187742#references
